/*!
 * Mojo
 * Copyright 2012 Agile Business Cloud Solutions Ltd.

 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *    http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Mustache=function(){var a={};var b=function(){};b.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":true},context:{},render:function(f,e,d,g){if(!g){this.context=e;this.buffer=[];}if(!this.includes("",f)){if(g){return f;}else{this.send(f);return;}}f=this.render_pragmas(f);var c=this.render_section(f,e,d);if(c===false){c=this.render_tags(f,e,d,g);}if(g){return c;}else{this.sendLines(c);}},send:function(c){if(c!==""){this.buffer.push(c);}},sendLines:function(e){if(e){var c=e.split("\n");for(var d=0;d<c.length;d++){this.send(c[d]);}}},render_pragmas:function(c){if(!this.includes("%",c)){return c;}var e=this;var d=this.getCachedRegex("render_pragmas",function(g,f){return new RegExp(g+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+f,"g");});return c.replace(d,function(h,f,g){if(!e.pragmas_implemented[f]){throw ({message:"This implementation of mustache doesn't understand the '"+f+"' pragma"});}e.pragmas[f]={};if(g){var i=g.split("=");e.pragmas[f][i[0]]=i[1];}return"";});},render_partial:function(c,e,d){c=this.trim(c);if(!d||d[c]===undefined){throw ({message:"unknown_partial '"+c+"'"});}if(typeof(e[c])!="object"){return this.render(d[c],e,d,true);}return this.render(d[c],e[c],d,true);},render_section:function(e,d,c){if(!this.includes("#",e)&&!this.includes("^",e)){return false;}var g=this;var f=this.getCachedRegex("render_section",function(i,h){return new RegExp("^([\\s\\S]*?)"+i+"(\\^|\\#)\\s*(.+)\\s*"+h+"\n*([\\s\\S]*?)"+i+"\\/\\s*\\3\\s*"+h+"\\s*([\\s\\S]*)$","g");});return e.replace(f,function(k,o,n,j,l,i){var q=o?g.render_tags(o,d,c,true):"",m=i?g.render(i,d,c,true):"",h,p=g.find(j,d);if(n==="^"){if(!p||g.is_array(p)&&p.length===0){h=g.render(l,d,c,true);}else{h="";}}else{if(n==="#"){if(g.is_array(p)){h=g.map(p,function(r){return g.render(l,g.create_context(r),c,true);}).join("");}else{if(g.is_object(p)){h=g.render(l,g.create_context(p),c,true);}else{if(typeof p==="function"){h=p.call(d,l,function(r){return g.render(r,d,c,true);});}else{if(p){h=g.render(l,d,c,true);}else{h="";}}}}}}return q+h+m;});},render_tags:function(l,c,e,g){var f=this;var k=function(){return f.getCachedRegex("render_tags",function(n,i){return new RegExp(n+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+i+"+","g");});};var h=k();var j=function(o,i,n){switch(i){case"!":return"";case"=":f.set_delimiters(n);h=k();return"";case">":return f.render_partial(n,c,e);case"{":return f.find(n,c);default:return f.escape(f.find(n,c));}};var m=l.split("\n");for(var d=0;d<m.length;d++){m[d]=m[d].replace(h,j,this);if(!g){this.send(m[d]);}}if(g){return m.join("\n");}},set_delimiters:function(d){var c=d.split(" ");this.otag=this.escape_regex(c[0]);this.ctag=this.escape_regex(c[1]);},escape_regex:function(d){if(!arguments.callee.sRE){var c=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];arguments.callee.sRE=new RegExp("(\\"+c.join("|\\")+")","g");}return d.replace(arguments.callee.sRE,"\\$1");},find:function(d,e){d=this.trim(d);function c(g){return g===false||g===0||g;}var f;if(c(e[d])){f=e[d];}else{if(c(this.context[d])){f=this.context[d];}}if(typeof f==="function"){return f.apply(e);}if(f!==undefined){return f;}return"";},includes:function(d,c){return c.indexOf(this.otag+d)!=-1;},escape:function(c){c=String(c===null?"":c);return c.replace(/&(?!\w+;)|["'<>\\]/g,function(d){switch(d){case"&":return"&amp;";case'"':return"&quot;";case"'":return"&#39;";case"<":return"&lt;";case">":return"&gt;";default:return d;}});},create_context:function(d){if(this.is_object(d)){return d;}else{var e=".";if(this.pragmas["IMPLICIT-ITERATOR"]){e=this.pragmas["IMPLICIT-ITERATOR"].iterator;}var c={};c[e]=d;return c;}},is_object:function(c){return c&&typeof c=="object";},is_array:function(c){return Object.prototype.toString.call(c)==="[object Array]";},trim:function(c){return c.replace(/^\s*|\s*$/g,"");},map:function(g,e){if(typeof g.map=="function"){return g.map(e);}else{var f=[];var c=g.length;for(var d=0;d<c;d++){f.push(e(g[d]));}return f;}},getCachedRegex:function(d,g){var f=a[this.otag];if(!f){f=a[this.otag]={};}var c=f[this.ctag];if(!c){c=f[this.ctag]={};}var e=c[d];if(!e){e=c[d]=g(this.otag,this.ctag);}return e;}};return({name:"mustache.js",version:"0.4.0-dev",to_html:function(e,c,d,g){var f=new b();if(g){f.send=g;}f.render(e,c||{},d);if(!g){return f.buffer.join("\n");}}});}();(function(g,j){var e=jQuery;var o=function(){};o.controllers={};o.applications={};o.options={};o._loaded=[];o.resolve=function m(p){if(!o._namespace._provided[p]){return p.replace(/\./gi,"/");}return false;};o._namespace=function d(s){var t=(""+s).split(/\./),v=t.length,u=[],r=window||{};if(!o._namespace._provided){o._namespace._provided={};}if(o._namespace._provided[s]==s){throw new Error(s+" has already been defined.");}for(var q=0;q<v;q+=1){var p=t[q];if(!r[p]){u[q]=p;r[p]=function(){};o._namespace._provided[u.join(".")]=r[p];}r=r[p];}return r;};o.template=function l(q,r,p){if("undefined"==typeof Mustache){return false;}if("undefined"==typeof q||!q){throw new Error("'template' is required");}if("undefined"==typeof r||!r){throw new Error("'data' is required");}return Mustache.to_html(q,r,p);};o.query=function i(){if(!arguments.length){return false;}return e.apply(this,arguments);};o.queryFirst=function b(){if(!arguments.length){return false;}var p=o.query.apply(this,arguments);if(!p.length){return false;}return p[0];};o.guid=function h(){var q=[],r="0123456789ABCDEF";for(var p=0;p<36;p++){q[p]=Math.floor(Math.random()*16);}q[14]=4;q[19]=(q[19]&3)|8;for(var p=0;p<36;p++){q[p]=r[q[p]];}q[8]=q[13]=q[18]=q[23]="-";return q.join("");};o.require=function c(t,w){if("undefined"==typeof t||!t){throw new Error("'dependencies' is required");}if("undefined"==typeof w||!w){throw new Error("'callback' is required");}if(!e.isArray(t)){t=[t];}var v=t.length,x,s=0;var p=o.controllers;for(var r=0;r<v;r++){var u=t[r];x=o.options.baseSrc+o.resolve(u)+".js";o._loaded.push(u);e.getScript(x,function(){s++;});}var q=setInterval(function(){if(w&&s==v){clearInterval(q);w.call(this);}},25);};o.requireSync=function k(p){var q=o.options.baseSrc+o.resolve(p)+".js";e.ajaxSetup({async:false});e.getScript(q);e.ajaxSetup({async:true});};o.getController=function n(p){if("undefined"==typeof o.controllers[p]){return false;}if("string"!=typeof p){return false;}return o.controllers[p];};o.fetch=function a(p,q){e.getScript(p,function(){if(q){q.apply(this,arguments);}});};o.define=function(q,p){if("undefined"==typeof q||!q){throw new Error("'id' is required");}if("undefined"==typeof p||!p){throw new Error(q+" missing factory implementation");}if("function"==typeof p){p=p.call(this,jQuery);}if("string"!=typeof q){return false;}if("string"==typeof q){o._namespace(q);o._loaded[q]=p;o.controllers[q]=p;}};o.create=function f(p){if(arguments.length>1){throw new Error("Incorrect arguments");}if("undefined"==typeof p){p={};if(!p.baseSrc){p.baseSrc="js/";}}e.extend(this.options,p);return new o.Application();};window.mojo=o;})(window,document);mojo.define("mojo.Messaging",function(){var c=jQuery,b=c({}),a=function(){};a.subscribe=function(){b.bind.apply(b,arguments);};a.unsubscribe=function(){b.unbind.apply(b,arguments);};a.publish=function(){b.trigger.apply(b,arguments);};window.mojo.Messaging=a;if(window.MOJO){window.MOJO.Messaging=a;}});mojo.define("mojo.Model",function(){var a=jQuery,b=function(){};b.set=function(c,e){var f=mojo.query('*[modelSource="'+c+'"]'),d;mojo._namespace(c);if(f.length){a(f).each(function(h,g){if(!g.mojoTemplate){g.mojoTemplate=a(g).html().replace("%7B%7B","{{").replace("%7D%7D","}}");}a(g).html("");var i=mojo.template(g.mojoTemplate,e);a(f).html(i);d=a(f).html();});return d;}else{window[c]=e;return window[c];}};b.get=function(c){if(!c){return false;}if("string"!=typeof c){return false;}if("undefined"==typeof mojo.ModelRegistry[c]){return false;}if(arguments.lenght>1){return false;}return mojo.ModelRegistry[c];};b.remove=function(c){if(!c){return false;}if("string"!=typeof(c)){return false;}if("undefined"==typeof mojo.ModelRegistry[c]){return false;}delete mojo.ModelRegistry[c];};window.mojo.Model=b;window.mojo.ModelRegistry={};if(window.MOJO){window.MOJO.Model=window.mojo.Model;}});mojo.define("mojo.Request",function Request(b){function a(f,c,e,d){if("undefined"==typeof f||!f){throw new Error("'paramsObj' is required");}if("undefined"==typeof c||!c){throw new Error("'callerObj' is required");}if("undefined"==typeof e||!e){throw new Error("'eventObj' is required");}if("undefined"==typeof d||!d){throw new Error("'controllerObj' is required");}this.paramsObj=f;this.callerObj=c;this.eventObj=e;this.controllerObj=d;}a.prototype.getController=function(){return this.controllerObj;};a.prototype.getContextElement=function(){return this.getController().getContextElement();};a.prototype.getCaller=function(){return this.callerObj;};a.prototype.getEvent=function(){return this.eventObj;};window.mojo.Request=a;});mojo.define("mojo.Controller",function(){var b=jQuery;var a=function(){};function c(){this.contextElement=null;this.controllerClass=null;this.events;}c.prototype.onInit=function(){};c.prototype.onParamChange=function(){};c.prototype.onComplete=function(){};c.prototype.onBind=function(){};c.prototype.onIntercept=function(){};c.prototype.params={};c.prototype.initialize=function(e,f,g){var d=this;d.contextElement=e;d.controllerClass=f;if("undefined"!=typeof g||!g){d.params=g;}b(d.events).each(function(l,k){var i=b(document),n=k[0],h=k[1],j=k[2],m=k[3];if(n=="context"){i=b(e);}b(i).delegate(h,j,function(o){d.onBind();var q=new mojo.Request(b(this).data()||{},this,o,d);if(typeof d.before!="undefined"&&typeof d.before[m]!="undefined"){d.before[m].call(d,q);d.onIntercept("Before");}if(!d.methods[m]||"undefined"==typeof d.methods[m]){throw new Error("Command does not exist within Controller");}try{d.methods[m].call(mojo.controllers[f],q);}catch(p){throw p;}if(typeof d.after!="undefined"&&typeof d.after[m]!="undefined"){d.after[m].call(d,q);d.onIntercept("After");}});});d.onInit();};c.prototype.getContextElement=function(){if(!this.contextElement){return null;}return this.contextElement;};c.prototype.param=function(d,e){if("undefined"==typeof this.params){this.params={};}if(arguments.length>1){this.params[d]=e;this.onParamChange();return this;}else{return this.params[d];}};window.mojo.Controller=c;if(window.MOJO){window.MOJO.Controller=c;}});mojo.define("mojo.Application",function(){var g=jQuery;function e(){if(!this.options){this.options={};}var k=this,l=k.options;l.locale="en_CA";l.plugins=[];l.pluginSrc="js/lib/plugins/";l.pluginsAsync=true;l.environment="dev";l.logging=false;l.selector=jQuery||(function(){throw new Error("Unable to find jQuery");})();k.siteMap=[];}e.prototype.onComplete=function(){};e.prototype.configure=function f(k,m){if(!arguments.length){throw new Error("passing no parameters into configure() is invalid");}if(arguments.length>2){throw new Error("passing too many parameters into configure() is invalid");}if(arguments.length>1){this.options[k]=m;if(this.options.environment=="dev"&&("undefined"!=typeof this.options.logging&&this.options.logging)){try{console.info("Configure: ",k," -> ",m);}catch(l){}}return this;}else{return this.options[k];}};e.prototype.map=function b(k,n){if("undefined"==typeof k||!k){throw new Error("'selector' is a required parameter");}if("undefined"==typeof n||!n){throw new Error("'callback' is a required parameter");}if("string"!=typeof k){throw new Error("'selector' needs to be a String");}if(g.isArray(n)&&n.length===0){throw new Error("'callback' is an array and is required to have controllers");}if(g.isArray(n)){g(n).each(function(p,o){if(!o.hasOwnProperty("controller")){throw new Error("'callback' must contain only Mojo Controller objects");}});}var l=this;var m=g(k);m.each(function(o,p){l.siteMap.push({context:p,init:n});});if("function"==typeof n){n.call(this,l);}return this;};e.prototype.setupController=function i(l,k,p){if("undefined"==typeof l||!l){throw new Error("'context' is a required parameter");}if("undefined"==typeof k||!k){throw new Error("'controller' is a required parameter");}var n=g(l);var m=mojo.controllers[k];var o=new mojo.Controller(),m=g.extend(m,m.methods),m=g.extend(m,o);mojo.controllers[k]=m;if(typeof m=="undefined"){throw new Error("Undefined Controller @ ",k);}m.initialize(l,k,p);if("undefined"==typeof l.mojoControllers){l.mojoControllers=[];}l.mojoControllers.push({controller:m});if(typeof m.after!="undefined"&&m.after.Start!="undefined"){m.after.Start.call(m,null);}if("undefined"!=typeof m.methods.Initialize){m.methods.Initialize.call(m);}};e.prototype.disconnectController=function a(l,k){if("undefined"==typeof l||!l){throw new Error("'node' is a required parameter");}if("undefined"==typeof k||!k){throw new Error("'controller' is a required parameter");}g(l).unbind().undelegate();if("undefined"!=typeof g(l)[0].mojoControllers){delete g(l)[0].mojoControllers;}return this;};e.prototype.disconnectControllers=function h(l){var k=this;g(this.siteMap).each(function(m,n){g(n.context).unbind().undelegate();if("undefined"!=typeof g(n.context)[0].mojoControllers){delete g(n.context)[0].mojoControllers;}});if("undefined"!=typeof l&&"function"==typeof l){l.apply(this);}};e.prototype.connectControllers=function c(){var k=this,l=[];g(k.siteMap).each(function(n,m){var o;if("function"==typeof m.init){o=m.init.call(this);}else{o=m.init;}g(o).each(function(p,q){if(!mojo.controllers.hasOwnProperty(q.controller)){l.push(q.controller);}else{mojo._loaded[q.controller]=q.controller;}});});mojo.require(g.unique(l),function(){g(k.siteMap).each(function(n,m){if(k.options.environment=="dev"&&k.options.logging){try{console.log("Mapping ["+n+"]: ",m.context);}catch(p){}}var o=("function"==typeof m.init)?m.init.call(this):m.init;g(o).each(function(q,r){k.setupController(m.context,r.controller,r.params);});mojo.Messaging.publish("/app/start");});});};e.prototype.getPlugins=function(m){var k=this,l=k.options.pluginSrc;if(!k.options.pluginsAsync){g.ajaxSetup({async:false});}g(k.options.plugins).each(function(n,o){mojo.fetch(l+o+".js");});if(!k.options.pluginsAsync){g.ajaxSetup({async:true});}if("undefined"!=typeof m&&"function"==typeof m){m.call(k);}};e.prototype.start=function d(){var k=this;g(document).ready(function(){k.disconnectControllers(function(){if(k.options.plugins.length){k.getPlugins(function(){mojo.Messaging.publish("/app/plugins/loaded");k.connectControllers();});}else{k.connectControllers();}k.onComplete();});});};e.prototype.remap=function j(){var k=this;k.disconnectControllers(function(){k.connectControllers();k.onComplete();});};window.mojo.Application=e;if(window.MOJO){window.MOJO.Application=e;}});mojo.define("mojo.Service",function Service(a){function b(d,e,c){if(typeof c=="undefined"){c={};}var f={method:c.method||function(){var g="get";if(d.match(/^get/i)){g="get";}else{if(d.match(/^add|del|update/i)){g="post";}}return g;}(),jsonp:false,wrapped:false,template:false,contentType:"application/json; charset=utf-8"};this.name=d;this.uri=e;this.options=a.extend({},f,c);}b.prototype.invoke=function(e,h,i){var j=this;var k=j.getOptions()||{},c=k.method,d=j.getURI(),g=k.responseType||"JSON";if("undefined"==typeof h||!h){throw new Error("'callback' is a required parameter");}if(k.template){d=j.parse(d,e);if(c=="get"){e=null;}}a.ajaxSetup({dataTypeString:g,dataType:k.jsonp?"jsonp":g,type:c,async:k.async||true,cache:k.cache||false,contentType:k.contentType||"application/json; charset=utf-8"});var f;if(c=="post"&&k.contentType.match(/application\/json/gi)){f=JSON.stringify(e);}else{f=e;}a.ajax({url:d,data:f,headers:{RequestId:mojo.guid()}}).success(function(l){if(g=="JSON"&&this.contentType.match(/javascript/g)){l=a.parseJSON(l);}if(k.wrapped){l=j.unwrap(l);}if("undefined"!=typeof h){if(typeof h=="function"){h.call(i,null,l);}else{i[h](null,l);}}}).error(function(){if("undefined"!=typeof h){h.call(i||this,"Unable to execute XHR",arguments);}});};b.prototype.getName=function(){return this.name;};b.prototype.getURI=function(){return this.uri;};b.prototype.getOptions=function(){return this.options;};b.prototype.unwrap=function(e){var d=this;var c={};for(var f in e){if(typeof f==="string"&&f.substr(f.length-6,f.length)=="Result"){e=d.convert(e[f]);break;}}return e;};b.prototype.convert=function(e){var c={};for(var d in e){c[d]=e[d];}return c;};b.prototype.option=function(){if(!arguments.length){return false;}if(arguments.length>2){return false;}if("string"!=typeof arguments[0]){return false;}if(arguments.length==2){this.options[arguments[0]]=arguments[1];return this;}else{if(arguments.length==1){return this.options[arguments[0]];}}};b.prototype.parse=function(c,d){if(arguments.length!=2){return false;}if("string"!=typeof c){return false;}if("object"!=typeof d){return false;}a.each(d,function(e,f){c=c.split("{"+e+"}").join(f);});return c;};window.mojo.Service=b;if(window.MOJO){window.MOJO.Service=b;}});mojo.define("mojo.ServiceLocator",function ServiceLocator(b){var a={services:{},addService:function(c){this.services[c.name]=c;return this;},getService:function(c){return this.services[c];},removeService:function(c){delete this.services[c];},removeServices:function(){this.services={};return true;},getServices:function(){return this.services;}};window.mojo.ServiceLocator=a;if(window.MOJO){window.MOJO.ServiceLocator=a;}});
mojo.Service.prototype.invoke = function (params, callback, scope, timeoutOpts) {
	var $ = jQuery;

  var self = this;

  var options = self.getOptions() || {},
                method = options.method,
                uri = self.getURI(),
                responseType = options.responseType || 'JSON';
  timeoutOpts = timeoutOpts||{};

  if ('undefined' == typeof callback || !callback) throw new Error("'callback' is a required parameter");

  if (options.template) {
    uri = self.parse(uri, params);
    if (method == 'get') params = null;
  }

  $.ajaxSetup({
    dataTypeString: responseType,
    dataType: options.jsonp ? 'jsonp' : responseType,
    timeout: timeoutOpts.expire || 60*60*1000, // 1h
    type: method,
    headers: { "cache-control": "no-cache" },
    async: options.async || true,
    cache: options.cache || false,
    contentType: options.contentType || "application/json; charset=utf-8"
  });

  var data;
  if (method == 'post' && options.contentType.match(/application\/json/gi)) {
    data = JSON.stringify(params);
  } else {
    data = params;
  }

  $.ajax({
    url: uri,
    data: data,
    headers: {
      "RequestId": mojo.guid()
    }
  }).success(function (data) {
    if (responseType == 'JSON' && this.contentType.match(/javascript/g)) {
      data = $.parseJSON(data);
    }

    if (options.wrapped) data = self.unwrap(data);

    if ('undefined' != typeof callback) {
      if (typeof callback == 'function') {
        callback.call(scope, null, data);
      } else {
        //string
        scope[callback](null, data);
      }
    }
    mojo.Messaging.publish("mojo.Service." + self.getName(), { response: data, service: self });
  }).error(function (a, errorType) {
    if( errorType == 'timeout' ){
      if(  typeof timeoutOpts.callback == 'function' ){
        timeoutOpts.callback.call((scope||this), errorType, self, params);
      // default Controller prototype call
      } else if( scope && typeof scope.onTimeout == 'function' ){
        scope.onTimeout.call((scope||this), errorType, self, params);
      }
    } else if ('undefined' != typeof callback) {
      callback.call(scope || this, "Unable to execute XHR", arguments);
    }
    mojo.Messaging.publish("mojo.Service." + self.getName(), { response: data, service: self });
  });
};
